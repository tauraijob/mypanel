// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATIONS (Multi-tenant)
// ============================================
model Organization {
  id             Int      @id @default(autoincrement())
  name           String
  slug           String   @unique  // For URL: mypanel.wecode.co.zw/org/wecode
  email          String
  phone          String?
  
  // Subscription
  planId         Int?
  plan           SubscriptionPlan? @relation(fields: [planId], references: [id])
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?
  billingCycle   String   @default("MONTHLY") // MONTHLY or YEARLY
  
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  users          User[]
  clients        Client[]
  services       Service[]
  invoices       Invoice[]
  payments       Payment[]
  quotations     Quotation[]
  settings       Settings?
  categories     ServiceCategory[]
  emailLogs      EmailLog[]

  @@map("organizations")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

// ============================================
// SUBSCRIPTION PLANS (Editable by Super Admin)
// ============================================
model SubscriptionPlan {
  id             Int       @id @default(autoincrement())
  name           String    @unique
  description    String?   @db.Text
  
  // Pricing
  monthlyPrice   Decimal   @db.Decimal(10, 2)
  yearlyPrice    Decimal   @db.Decimal(10, 2)
  
  // Limits
  maxClients     Int       @default(-1) // -1 = unlimited
  maxUsers       Int       @default(-1)
  maxServices    Int       @default(-1)
  
  // Features (comma-separated or JSON)
  features       String?   @db.Text
  
  isActive       Boolean   @default(true)
  sortOrder      Int       @default(0)
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  organizations  Organization[]

  @@map("subscription_plans")
}

// ============================================
// SUPER ADMIN SETTINGS
// ============================================
model SuperAdminSettings {
  id             Int      @id @default(autoincrement())
  
  // Platform Info
  platformName   String   @default("MyPanel")
  platformUrl    String?
  supportEmail   String?
  
  // SMTP Email Settings
  smtpHost       String?
  smtpPort       Int      @default(587)
  smtpUser       String?
  smtpPass       String?
  smtpFrom       String?
  smtpSecure     Boolean  @default(false)
  
  // PayPal
  paypalEmail    String?
  paypalEnabled  Boolean  @default(false)
  
  // Paynow
  paynowIntegrationId    String?
  paynowIntegrationKey   String?
  paynowEnabled          Boolean @default(false)
  
  // Branding
  logoUrl        String?
  primaryColor   String   @default("#3b82f6")
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("super_admin_settings")
}


// ============================================
// USERS & ROLES
// ============================================
model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  password       String
  name           String
  phone          String?
  avatar         String?
  role           UserRole  @default(ADMIN)
  isActive       Boolean   @default(true)
  lastLogin      DateTime?
  
  // Email verification
  emailVerified       Boolean   @default(false)
  verificationToken   String?
  verificationExpires DateTime?
  
  // Password reset
  passwordResetToken   String?
  passwordResetExpires DateTime?
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Organization relation (null for SUPER_ADMIN)
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("users")
}

enum UserRole {
  SUPER_ADMIN // Platform super admin (you)
  ADMIN       // Organization admin - full access within org
  SALES       // Can manage clients, invoices, quotations, record payments
  SUPPORT     // Can view clients, services
  VIEWER      // Read-only access
}

// ============================================
// ORGANIZATION SETTINGS
// ============================================
model Settings {
  id              Int      @id @default(autoincrement())
  
  // Company Info
  companyName     String   @default("My Company")
  companyEmail    String?
  companyPhone    String?
  companyAddress  String?  @db.Text
  companyCity     String?
  companyState    String?
  companyZip      String?
  companyCountry  String?
  companyWebsite  String?
  companyTaxId    String?
  logoUrl         String?
  
  // Invoice Settings
  invoicePrefix   String   @default("INV-")
  quotePrefix     String   @default("QUO-")
  currency        String   @default("USD")
  currencySymbol  String   @default("$")
  taxRate         Decimal  @default(0) @db.Decimal(5, 2)
  paymentTerms    String?  @db.Text
  invoiceNotes    String?  @db.Text
  invoiceFooter   String?  @db.Text
  bankDetails     String?  @db.Text
  
  // Email reminder settings
  reminderDays    String   @default("14,7,3,1")
  overdueDays     String   @default("1,3,7,14")
  autoSuspendDays Int      @default(14)
  
  // SMTP Settings (per-org)
  smtpHost        String?
  smtpPort        Int?
  smtpUser        String?
  smtpPass        String?
  smtpFrom        String?
  
  // Payment Gateways (Collecting from Clients)
  paypalClientId  String?
  paypalSecret    String?
  paypalMode      String?   @default("sandbox")
  
  paynowIntegrationId  String?
  paynowIntegrationKey String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Organization relation
  organizationId  Int      @unique
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("settings")
}

// ============================================
// CLIENTS
// ============================================
model Client {
  id             Int       @id @default(autoincrement())
  name           String
  email          String
  phone          String?
  company        String?
  
  // Billing Address
  billingAddress  String?  @db.Text
  billingCity     String?
  billingState    String?
  billingZip      String?
  billingCountry  String?
  
  // Optional Service Address
  serviceAddress  String?  @db.Text
  serviceCity     String?
  serviceState    String?
  serviceZip      String?
  serviceCountry  String?
  
  notes          String?   @db.Text
  status         ClientStatus @default(ACTIVE)
  
  // Portal Access
  password       String?
  portalAccess   Boolean   @default(false)
  lastLogin      DateTime?
  resetToken     String?
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Organization relation
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  services       Service[]
  invoices       Invoice[]
  quotations     Quotation[]
  payments       Payment[]

  @@unique([email, organizationId])
  @@map("clients")
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ============================================
// SERVICE CATEGORIES
// ============================================
model ServiceCategory {
  id          Int       @id @default(autoincrement())
  name        String
  description String?   @db.Text
  color       String    @default("#3b82f6")
  icon        String    @default("server")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Organization relation
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  services    Service[]

  @@unique([name, organizationId])
  @@map("service_categories")
}

// ============================================
// SERVICES (Assigned to Clients)
// ============================================
model Service {
  id             Int           @id @default(autoincrement())
  name           String
  description    String?       @db.Text
  
  // Pricing
  price          Decimal       @db.Decimal(10, 2)
  billingCycle   BillingCycle  @default(MONTHLY)
  
  // Dates
  startDate      DateTime
  nextDueDate    DateTime
  expiryDate     DateTime?
  
  // Status
  status         ServiceStatus @default(PENDING)
  
  // Metadata
  domain         String?
  server         String?
  username       String?
  notes          String?       @db.Text
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Organization relation
  organizationId Int
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  clientId       Int
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  categoryId     Int
  category       ServiceCategory @relation(fields: [categoryId], references: [id])
  
  invoiceItems   InvoiceItem[]

  @@map("services")
}

enum BillingCycle {
  ONETIME
  MONTHLY
  QUARTERLY
  SEMIANNUALLY
  ANNUALLY
  BIENNIALLY
}

enum ServiceStatus {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
  CANCELLED
}

// ============================================
// INVOICES
// ============================================
model Invoice {
  id             Int           @id @default(autoincrement())
  invoiceNumber  String
  
  // Dates
  issueDate      DateTime      @default(now())
  dueDate        DateTime
  paidDate       DateTime?
  
  // Amounts
  subtotal       Decimal       @db.Decimal(10, 2)
  taxAmount      Decimal       @default(0) @db.Decimal(10, 2)
  discount       Decimal       @default(0) @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  amountPaid     Decimal       @default(0) @db.Decimal(10, 2)
  
  // Status
  status         InvoiceStatus @default(DRAFT)
  
  // Notes
  notes          String?       @db.Text
  terms          String?       @db.Text
  
  // Reminder tracking
  lastReminderSent DateTime?
  reminderCount    Int         @default(0)
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Organization relation
  organizationId Int
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  clientId       Int
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  items          InvoiceItem[]
  payments       Payment[]

  @@unique([invoiceNumber, organizationId])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// ============================================
// INVOICE ITEMS
// ============================================
model InvoiceItem {
  id          Int      @id @default(autoincrement())
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2)
  amount      Decimal  @db.Decimal(10, 2)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  invoiceId   Int
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  serviceId   Int?
  service     Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@map("invoice_items")
}

// ============================================
// PAYMENTS
// ============================================
model Payment {
  id            Int           @id @default(autoincrement())
  amount        Decimal       @db.Decimal(10, 2)
  paymentDate   DateTime      @default(now())
  paymentMethod PaymentMethod @default(BANK_TRANSFER)
  reference     String?
  notes         String?       @db.Text
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Organization relation
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  invoiceId     Int
  invoice       Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  clientId      Int
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CREDIT_CARD
  PAYPAL
  PAYNOW
  MOBILE_MONEY
  CRYPTO
  OTHER
}

// ============================================
// QUOTATIONS
// ============================================
model Quotation {
  id              Int             @id @default(autoincrement())
  quoteNumber     String
  
  // Dates
  issueDate       DateTime        @default(now())
  validUntil      DateTime
  
  // Amounts
  subtotal        Decimal         @db.Decimal(10, 2)
  taxAmount       Decimal         @default(0) @db.Decimal(10, 2)
  discount        Decimal         @default(0) @db.Decimal(10, 2)
  total           Decimal         @db.Decimal(10, 2)
  
  // Status
  status          QuotationStatus @default(DRAFT)
  
  // Notes
  notes           String?         @db.Text
  terms           String?         @db.Text
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Organization relation
  organizationId  Int
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  clientId        Int
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  items           QuotationItem[]

  @@unique([quoteNumber, organizationId])
  @@map("quotations")
}

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
  CONVERTED
}

// ============================================
// QUOTATION ITEMS
// ============================================
model QuotationItem {
  id          Int       @id @default(autoincrement())
  description String
  quantity    Int       @default(1)
  unitPrice   Decimal   @db.Decimal(10, 2)
  amount      Decimal   @db.Decimal(10, 2)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  quotationId Int
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  @@map("quotation_items")
}

// ============================================
// EMAIL LOGS
// ============================================
model EmailLog {
  id          Int       @id @default(autoincrement())
  recipient   String
  subject     String
  body        String    @db.Text
  type        EmailType
  status      String    @default("sent")
  error       String?   @db.Text
  
  // Reference to related entity
  referenceType String?
  referenceId   Int?
  
  sentAt      DateTime  @default(now())

  // Organization relation
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("email_logs")
}

enum EmailType {
  INVOICE_CREATED
  INVOICE_REMINDER
  INVOICE_OVERDUE
  QUOTE_SENT
  SERVICE_ACTIVATED
  SERVICE_SUSPENDED
  SERVICE_UNSUSPENDED
  SERVICE_TERMINATED
  SERVICE_EXPIRING
  PAYMENT_RECEIVED
  WELCOME
  VERIFICATION
  CONTACT_FORM
  PASSWORD_RESET
  SUBSCRIPTION_REMINDER
  ADMIN_NOTIFICATION
  BACKUP
  CUSTOM
}

// ============================================
// ORGANIZATION PAYMENTS (Platform Subscriptions)
// ============================================
model OrganizationPayment {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  paymentMethod   String   // "PAYPAL" or "PAYNOW"
  transactionId   String?
  status          String   @default("PENDING") // PENDING, COMPLETED, FAILED
  
  // Subscription period
  periodStart     DateTime?
  periodEnd       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("organization_payments")
}
